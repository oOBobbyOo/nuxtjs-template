<script setup lang="ts">
import ColorThief from 'colorthief'
import { map } from 'lodash-es'
import { getRandomImg } from '@/utils'

// 图片数组
const imgs = getRandomImg(8)

// 当前悬停的图片索引
const hoverIndex = ref(-1)

const colorThief = new ColorThief()

const colorThiefRef = ref<HTMLElement>()

// 鼠标悬停回调
function onMouseOver(event: MouseEvent, i: number) {
  hoverIndex.value = i
  const img = event.target as HTMLImageElement
  let colors = colorThief.getPalette(img, 3)
  colors = map(colors, c => `rgb(${c[0]}, ${c[1]}, ${c[2]})`)
  if (colorThiefRef.value) {
    colorThiefRef.value.style.setProperty('--c1', colors[0])
    colorThiefRef.value.style.setProperty('--c2', colors[1])
    colorThiefRef.value.style.setProperty('--c3', colors[2])
  }
}

// 鼠标移出回调
function onMouseOut() {
  hoverIndex.value = -1
  if (colorThiefRef.value) {
    colorThiefRef.value.style.setProperty('--c1', '#fff')
    colorThiefRef.value.style.setProperty('--c2', '#fff')
    colorThiefRef.value.style.setProperty('--c3', '#fff')
  }
}
</script>

<template>
  <div class="space-y-4">
    <PageCard class="space-y-4 !rounded-md">
      <h1 class="text-xl font-bold">
        图片取色盘
      </h1>
      <p>
        核心是使用色彩聚合算法提取图片主色调生成渐变背景
      </p>
    </PageCard>

    <div
      ref="colorThiefRef"
      class="colorthief-container grid grid-cols-2 gap-2 rounded-md p-4 lg:grid-cols-4 md:grid-cols-3"
    >
      <div v-for="i in 8" :key="i" :span="8" class="imgbox">
        <img
          :src="imgs[i - 1]" class="color-img h-full w-full cursor-pointer rounded-md object-cover"
          :style="{
            opacity: hoverIndex === -1 ? 1 : hoverIndex === i ? 1 : 0.3,
            filter: `blur(${hoverIndex === -1 ? '0px' : hoverIndex === i ? '0px' : '1px'})`,
          }"
          @mouseover="onMouseOver($event, i)"
          @mouseout="onMouseOut()"
        >
      </div>
    </div>
  </div>
</template>

<style scoped lang="less">
@property --c1 {
  syntax: '<color>';
  initial-value: transparent;
  inherits: false;
}

@property --c2 {
  syntax: '<color>';
  initial-value: transparent;
  inherits: false;
}

@property --c3 {
  syntax: '<color>';
  initial-value: transparent;
  inherits: false;
}

.colorthief-container {
  background: linear-gradient(to bottom, var(--c1) 33%, var(--c2) 66%, var(--c3) 100%);
  animation: spread 0.35s ease-in forwards;
  transition-property: --c1, --c2, --c3;
  transition-duration: 0.35s;
  transition-timing-function: ease-in;
  height: calc(100vh - 322px);

  .imgbox {
    width: 100%;
    height: 100%;
    overflow: hidden;
    transition: 0.5s;
    border-radius: 5px;
    border: 4px solid transparent;

    &:hover {
      filter: drop-shadow(2px 2px 10px rgba(0, 0, 0, 0.5));
      border-color: #fff;
      transform: scale(1.05);
    }
  }
}
</style>
